<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feed produktowy XML</title>
  <style>
    :root {
      --bg: #f7f5f0;
      --card: #ffffff;
      --accent: #d5a20d;
      --muted: #6b7280;
      --text: #1f2937;
      --danger: #b91c1c;
      --ok: #15803d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(213,162,13,0.1), transparent 60%),
        radial-gradient(1000px 700px at 110% 10%, rgba(213,162,13,0.15), transparent 60%),
        var(--bg);
    }
    .card {
      width: min(720px, 92vw);
  background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));
  border: 1px solid rgba(213,162,13,0.2);
      border-radius: 16px;
      padding: 28px;
  box-shadow: 0 18px 40px rgba(31,41,55,0.12);
  backdrop-filter: blur(6px);
    }
    .header {
      display: flex; align-items: center; justify-content: center; margin-bottom: 18px;
    }
    .title { display: flex; align-items: center; justify-content: center; }
    .title img { height: 44px; display: block; }
  .muted { color: var(--muted); font-size: 0.95rem; margin: 8px 0 18px; }
    .dropzone {
      border: 1.5px dashed rgba(213,162,13,0.25);
      background: rgba(213,162,13,0.06);
      border-radius: 14px;
      padding: 28px;
      display: grid; place-items: center;
      transition: border-color .2s, background-color .2s, transform .2s;
    }
    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(213,162,13,0.18);
    }
    .dropzone p { margin: 8px 0; }
    .btn {
      background: linear-gradient(90deg, #d5a20d, #f1c545);
      border: none; color: #1f2937; padding: 12px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
      box-shadow: 0 8px 24px rgba(213,162,13,0.24);
      transition: transform .06s ease-in-out, box-shadow .2s;
    }
    .btn:disabled {
      opacity: 0.6; cursor: not-allowed; box-shadow: none;
    }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; width: 100%; }
  .file-name { flex: 1; color: var(--muted); font-size: 0.9rem; display: flex; align-items: center; }
    .status { margin-top: 14px; font-size: 0.95rem; }
    .status.error { color: var(--danger); }
    .status.ok { color: var(--ok); }
    input[type="file"] { display: none; }
    .ghost {
      background: rgba(255,255,255,0.7); border: 1px solid rgba(213,162,13,0.4); color: var(--accent); padding: 10px 14px; border-radius: 10px; cursor: pointer;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="header">
      <div class="title">
        <a href="https://twojsklep.pl" rel="noopener noreferrer">
          <img src="https://twojsklep.pl/themes/classic/templates/_partials/logo.png" alt="Twój sklep" loading="lazy" />
        </a>
      </div>
    </div>
    <p class="muted">Wgraj plik CSV z produktami i uruchom konwersję. Feed produktowy zostanie pobrany automatycznie jako plik XML.</p>

    <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Upuść plik CSV tutaj">
      <p>Przeciągnij i upuść plik CSV tutaj</p>
      <p class="muted">lub</p>
      <label class="ghost">
        Wybierz plik
        <input id="fileInput" type="file" accept=".csv,text/csv" />
      </label>
    </div>

    <div class="row" style="margin-top:12px;">
      <span class="file-name" id="fileName">Nie wybrano pliku</span>
  <button id="convertBtn" class="btn" disabled>Konwertuj</button>
    </div>

    <div id="status" class="status"></div>
  </main>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const convertBtn = document.getElementById('convertBtn');
    const statusEl = document.getElementById('status');
    let currentFile = null;

    function setStatus(msg, kind = '') {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + kind;
    }

    function setFile(file) {
      currentFile = file;
      fileName.textContent = file ? file.name : 'Nie wybrano pliku';
      convertBtn.disabled = !file;
    }

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const f = e.dataTransfer.files?.[0];
      if (f) setFile(f);
    });
    dropzone.addEventListener('click', (e) => {
      if (e.target.closest('label')) {
        return;
      }
      fileInput.click();
    });
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) setFile(f);
    });

    convertBtn.addEventListener('click', async () => {
      if (!currentFile) return;
      setStatus('Wysyłanie i konwersja…', '');
      convertBtn.disabled = true;

      try {
        const fd = new FormData();
        fd.append('file', currentFile);

        const res = await fetch('/convert', {
          method: 'POST',
          body: fd,
        });

        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(text || ('Błąd serwera: ' + res.status));
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const filename = 'output.xml';
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('Gotowe — plik XML został pobrany.', 'ok');
      } catch (err) {
        console.error(err);
        setStatus('Błąd: ' + err.message, 'error');
      } finally {
        convertBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
